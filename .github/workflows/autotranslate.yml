# ==============================================================================
#  Workflow: Smart Automatic i18n Translation (v4 - Production Ready)
#
#  Features:
#  - Uses a dedicated GitHub App for secure, isolated authentication.
#  - Prevents recursive workflow runs by checking the commit message.
#  - Employs a "three-dot diff" to precisely identify PR-specific changes.
# ==============================================================================

name: Smart Automatic i18n Translation

on:
  push:
    branches:
      - main
    paths:
      - 'crater-website/content/docs/**'
      - 'crater-website/messages/**'
      - 'crater-website/src/i18n/config.ts'
      - '.github/workflows/auto-translate.yml'
  pull_request:
    types:
      - labeled

jobs:
  auto-translate:
    # é€šè¿‡æ£€æŸ¥æœ€åä¸€æ¬¡çš„ commit message æ¥é˜²æ­¢å·¥ä½œæµè¢«è‡ªå·±çš„æäº¤æ‰€è§¦å‘ï¼Œè¿™æ˜¯æœ€ç®€å•å¯é çš„æ–¹å¼ã€‚
    if: "!startsWith(github.event.head_commit.message, 'chore(i18n):')"

    runs-on: self-hosted
    steps:
      # æ­¥éª¤ 1: ä½¿ç”¨ GitHub App çš„ ID å’Œç§é’¥ç”Ÿæˆä¸€ä¸ªçŸ­æœŸæœ‰æ•ˆçš„å®‰è£…ä»¤ç‰Œ
      - name: ğŸ” Generate a token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      # æ­¥éª¤ 2: ä½¿ç”¨ App ç”Ÿæˆçš„ä»¤ç‰Œæ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
      - name: ğŸ Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install dependencies
        run: pip install requests

      # æ­¥éª¤ 4: æ™ºèƒ½ç¡®å®šéœ€è¦å¤„ç†çš„æ–‡ä»¶å¹¶ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆ Diff
      - name: âš™ï¸ Determine Files & Generate Diffs
        id: files-to-process
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.event.after }}"
          else # pull_request
            BASE_REF="origin/${{ github.base_ref }}"
            HEAD_REF="origin/${{ github.head_ref }}"
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} --no-tags
          fi
          
          # ä½¿ç”¨ä¸‰ç‚¹ diff (`...`) ç²¾ç¡®æ‰¾å‡ºæœ¬æ¬¡äº‹ä»¶ç‹¬æœ‰çš„å˜æ›´
          FILES_TO_PROCESS=$(git diff --name-only --diff-filter=AMR $BASE_REF...$HEAD_REF)

          if [[ -z "$FILES_TO_PROCESS" ]]; then
            echo "No new or modified files unique to this event were detected. Workflow will stop."
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_files=true" >> $GITHUB_OUTPUT
          echo "Files to process:"
          echo "$FILES_TO_PROCESS"
          
          # åˆ›å»ºç”¨äºå­˜æ”¾ diff çš„ä¸´æ—¶ç›®å½•
          mkdir -p .diff_cache

          # ä¸ºæ¯ä¸ªè¢«ä¿®æ”¹çš„æ–‡ä»¶(Modified/Renamed)ç”Ÿæˆ diff
          MODIFIED_FILES=$(git diff --name-only --diff-filter=MR $BASE_REF...$HEAD_REF)
          for file in $MODIFIED_FILES; do
            # å°†æ–‡ä»¶è·¯å¾„ä¸­çš„ / æ›¿æ¢ä¸º _ï¼Œä½œä¸º diff æ–‡ä»¶å
            diff_filename=$(echo "$file" | tr '/' '_')
            git diff --no-prefix $BASE_REF...$HEAD_REF -- "$file" > ".diff_cache/${diff_filename}.diff"
            echo "  - Created diff for $file"
          done

          # å°†æ–‡ä»¶åˆ—è¡¨è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å‚æ•°
          FILES_TO_PROCESS_ARG=$(echo "$FILES_TO_PROCESS" | tr '\n' ',' | sed 's/,$//')
          echo "files=${FILES_TO_PROCESS_ARG}" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 5: è¿è¡Œå¼•å¯¼è„šæœ¬ï¼Œä¼ å…¥å˜æ›´æ–‡ä»¶åˆ—è¡¨
      - name: ğŸš€ Run Translation Bootstrap Script
        if: steps.files-to-process.outputs.has_files == 'true'
        run: |
          python crater-website/hack/i18n/bootstrap.py --changed-files "${{ steps.files-to-process.outputs.files }}"

      # æ­¥éª¤ 6: ä½¿ç”¨ App èº«ä»½åˆ›å»ºåŒ…å«ç¿»è¯‘ç»“æœçš„ Pull Request
      - name: ğŸ¤– Create Pull Request with Translations
        if: steps.files-to-process.outputs.has_files == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: "chore(i18n): è‡ªåŠ¨åŒæ­¥å¤šè¯­è¨€ç¿»è¯‘"
          title: "ğŸŒ [Auto-Translate] åŒæ­¥å¤šè¯­è¨€æ–‡ä»¶"
          body: |
            ç”± **${{ secrets.APP_NAME }}** æœºå™¨äººæ ¹æ®æœ€æ–°å˜æ›´è‡ªåŠ¨åŒæ­¥ç¿»è¯‘ã€‚
            
            **è§¦å‘äº‹ä»¶:** `${{ github.event_name }}`
            
            *æ­¤ PR åªåŒ…å«æœ¬æ¬¡äº‹ä»¶ä¸­ç‹¬æœ‰çš„å˜æ›´ï¼Œå·²æ™ºèƒ½æ’é™¤åˆå¹¶ä¸»å¹²æ‰€å¼•å…¥çš„ commitsã€‚*
          branch: "feature/auto-translate-${{ github.run_id }}"
          delete-branch: true
          labels: "i18n, automated"
          # ä½¿ç”¨ App çš„ä¿¡æ¯ä½œä¸ºä½œè€…ï¼Œè®© commit å†å²æ¸…æ™°å¯è¾¨
          author: ${{ secrets.APP_NAME }}[bot] <${{ secrets.APP_ID }}+${{ secrets.APP_NAME }}[bot]@users.noreply.github.com>
          committer: ${{ secrets.APP_NAME }}[bot] <${{ secrets.APP_ID }}+${{ secrets.APP_NAME }}[bot]@users.noreply.github.com>