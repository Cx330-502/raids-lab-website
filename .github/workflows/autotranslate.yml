# ==============================================================================
#  Workflow: Smart Automatic i18n Translation
#  
#  åŠŸèƒ½:
#  1. è‡ªåŠ¨æ£€æµ‹ content/docs, messages, å’Œ i18n é…ç½®æ–‡ä»¶çš„å˜æ›´ã€‚
#  2. åœ¨ push åˆ° main åˆ†æ”¯æˆ–ç»™ PR æ‰“ä¸Š 'run-translation' æ ‡ç­¾æ—¶è§¦å‘ã€‚
#  3. æ™ºèƒ½è¯†åˆ«æ–°å¢ã€ä¿®æ”¹ã€é‡å‘½åçš„æ–‡ä»¶ï¼Œå¹¶å¿½ç•¥è¢«åˆ é™¤çš„æ–‡ä»¶ã€‚
#  4. è°ƒç”¨ Python è„šæœ¬å¤„ç†ç¿»è¯‘é€»è¾‘ã€‚
#  5. è‡ªåŠ¨å°†ç¿»è¯‘ç»“æœåˆ›å»ºä¸€ä¸ªæ–°çš„ Pull Requestã€‚
# ==============================================================================

name: Smart Automatic i18n Translation

# ==============================================================================
#  è§¦å‘æ¡ä»¶ (Triggers)
# ==============================================================================
on:
  # åœºæ™¯ 1: å½“ä»£ç è¢«æ¨é€åˆ° main åˆ†æ”¯ï¼Œå¹¶ä¸”å˜æ›´å†…å®¹æ¶‰åŠæ–‡æ¡£ã€æ¶ˆæ¯æˆ–i18né…ç½®æ—¶
  push:
    branches:
      - main
    paths:
      - 'crater-website/content/docs/**'
      - 'crater-website/messages/**'
      - 'crater-website/src/i18n/config.ts'
      - '.github/**'

  # åœºæ™¯ 2: å½“ä¸€ä¸ªæ‰“å¼€çš„ Pull Request è¢«æ‰“ä¸Š 'run-translation' æ ‡ç­¾æ—¶
  pull_request:
    types:
      - labeled

# ==============================================================================
#  å·¥ä½œæµä»»åŠ¡ (Jobs)
# ==============================================================================
jobs:
  auto-translate:
    # --- æ¡ä»¶æ‰§è¡Œ ---
    # ä»…åœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œæ—¶æ‰æ‰§è¡Œæ­¤ä»»åŠ¡:
    # - äº‹ä»¶æ˜¯æ¨é€åˆ° main åˆ†æ”¯
    # - æˆ–è€…äº‹ä»¶æ˜¯ç»™ PR æ‰“æ ‡ç­¾ï¼Œä¸”æ ‡ç­¾åå¿…é¡»æ˜¯ 'run-translation'
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.label.name == 'run-translation')

    # --- è¿è¡Œç¯å¢ƒ ---
    # å…³é”®ï¼šæŒ‡å®šä½¿ç”¨æ‚¨é…ç½®å¥½çš„ self-hosted runner
    runs-on: self-hosted

    # --- ä»»åŠ¡æ­¥éª¤ ---
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿ git diff èƒ½æ­£ç¡®æ¯”è¾ƒåˆ†æ”¯é—´çš„å·®å¼‚
          fetch-depth: 0
          # ä½¿ç”¨ PATï¼Œå› ä¸ºå®ƒæœ‰æƒé™è§¦å‘æ–°çš„ PR åˆ›å»ºå·¥ä½œæµ
          token: ${{ secrets.PAT_FOR_ACTIONS }}

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # è¯·æ ¹æ®æ‚¨ runner çš„ç¯å¢ƒä¿®æ”¹

      # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å‡è®¾æ‚¨çš„ translation_client.py åªéœ€è¦ requests
          pip install requests
          # å¦‚æœæ‚¨æœ‰ requirements.txt æ–‡ä»¶, æ¨èä½¿ç”¨:
          # pip install -r requirements.txt

      # æ­¥éª¤ 4: ç¡®å®šéœ€è¦å¤„ç†çš„æ–‡ä»¶ (æ–°å¢/ä¿®æ”¹/é‡å‘½å)
      - name: âš™ï¸ Determine Files to Process (Added/Modified/Renamed)
        id: files-to-process
        run: |
          # è®¾ç½®æ¯”è¾ƒçš„åŸºå‡†ç‚¹
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.event.after }}"
            echo "Event: Push to main. Comparing commits $BASE_REF...$HEAD_REF"
          else # pull_request
            git fetch origin ${{ github.base_ref }}
            git fetch origin ${{ github.head_ref }}
            BASE_REF="origin/${{ github.base_ref }}"
            HEAD_REF="origin/${{ github.head_ref }}"
            echo "Event: PR labeled. Comparing branches $BASE_REF...$HEAD_REF"
          fi

          # ä½¿ç”¨ git diff --diff-filter ç­›é€‰æ–‡ä»¶çŠ¶æ€
          # A = Added, M = Modified, R = Renamed
          # D = Deleted çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨å¿½ç•¥
          FILES_TO_PROCESS=$(git diff --name-only --diff-filter=AMR $BASE_REF $HEAD_REF)
          DELETED_FILES=$(git diff --name-only --diff-filter=D $BASE_REF $HEAD_REF)

          if [[ -n "$DELETED_FILES" ]]; then
            echo "Detected deleted files (will be ignored by translation script):"
            echo "$DELETED_FILES"
          fi

          if [[ -z "$FILES_TO_PROCESS" ]]; then
            echo "No new or modified files detected that require translation. Workflow will stop."
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # å°†éœ€è¦å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å‚æ•°
          FILES_TO_PROCESS_ARG=$(echo "$FILES_TO_PROCESS" | tr '\n' ',' | sed 's/,$//')
          
          echo "Detected added/modified files to process:"
          echo "$FILES_TO_PROCESS"
          
          # è¾“å‡ºç»“æœä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "has_files=true" >> $GITHUB_OUTPUT
          echo "files=${FILES_TO_PROCESS_ARG}" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 5: è¿è¡Œç¿»è¯‘å¼•å¯¼è„šæœ¬
      - name: ğŸš€ Run Translation Bootstrap Script
        # ä»…å½“ä¸Šä¸€æ­¥ç¡®å®šæœ‰éœ€è¦å¤„ç†çš„æ–‡ä»¶æ—¶æ‰è¿è¡Œ
        if: steps.files-to-process.outputs.has_files == 'true'
        run: |
          python scripts/bootstrap.py --changed-files "${{ steps.files-to-process.outputs.files }}"

      # æ­¥éª¤ 6: æäº¤å˜æ›´å¹¶åˆ›å»º Pull Request
      - name: ğŸ¤– Create Pull Request with Translations
        # ä»…å½“ä¸Šä¸€æ­¥ç¡®å®šæœ‰éœ€è¦å¤„ç†çš„æ–‡ä»¶æ—¶æ‰è¿è¡Œ
        if: steps.files-to-process.outputs.has_files == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_FOR_ACTIONS }}
          commit-message: "chore(i18n): è‡ªåŠ¨åŒæ­¥å¤šè¯­è¨€ç¿»è¯‘"
          title: "ğŸŒ [Auto-Translate] åŒæ­¥å¤šè¯­è¨€æ–‡ä»¶"
          body: |
            ç”± GitHub Actions æœºå™¨äººæ ¹æ®æœ€æ–°å˜æ›´è‡ªåŠ¨åŒæ­¥ç¿»è¯‘ã€‚

            - **æ–°å¢æˆ–ä¿®æ”¹**çš„æ–‡ä»¶å·²è‡ªåŠ¨ç¿»è¯‘ã€‚
            - **å·²åˆ é™¤**çš„æ–‡ä»¶å·²è¢«æ™ºèƒ½å¿½ç•¥ã€‚

            **è§¦å‘äº‹ä»¶:** `${{ github.event_name }}`
            
            *å·¥ä½œæµæ—¥å¿—ä¸­çš„ "Run Translation Bootstrap Script" æ­¥éª¤ä¼šæ˜¾ç¤ºæœ¬æ¬¡ç¿»è¯‘æ‰€ä½¿ç”¨çš„åŸºå‡†æ–‡ä»¶ã€‚*

            è¯·å®¡æŸ¥ç”± AI ç”Ÿæˆçš„ç¿»è¯‘å¹¶åˆå¹¶ã€‚
          branch: "feature/auto-translate-${{ github.run_id }}"
          delete-branch: true
          labels: "i18n, automated"