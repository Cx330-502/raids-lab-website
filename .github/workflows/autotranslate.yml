# ==============================================================================
#  Workflow: Smart Automatic i18n Translation (v5 - Enhanced)
#
#  Features:
#  - Uses a dedicated GitHub App for secure, isolated authentication.
#  - Prevents recursive runs by checking commit message AND author.
#  - Ignores commits made by the generic 'github-actions[bot]'.
#  - Ignores file changes that only consist of whitespace modifications.
# ==============================================================================

name: Smart Automatic i18n Translation

on:
  push:
    branches:
      - main
    paths:
      - 'crater-website/content/docs/**'
      - 'crater-website/messages/**'
      - 'crater-website/src/i18n/config.ts'
      - '.github/workflows/auto-translate.yml'
  pull_request:
    types:
      - labeled

jobs:
  auto-translate:
    # 通过检查最后一次的 commit message 来防止工作流被自己的提交所触发，这是最简单可靠的方式。
    if: "!startsWith(github.event.head_commit.message, 'chore(i18n):')"

    runs-on: self-hosted
    steps:
      - name: 🔐 Generate a token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}
          
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: 🐍 Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Install dependencies
        run: pip install requests

      - name: ⚙️ Determine Files & Generate Diffs (Ignoring Whitespace)
        id: files-to-process
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.event.after }}"
          else
            BASE_REF="origin/${{ github.base_ref }}"
            HEAD_REF="origin/${{ github.head_ref }}"
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} --no-tags
          fi
          
          # --- 核心修改: 添加 -w (--ignore-all-space) 选项 ---
          GIT_DIFF_CMD="git diff -w --name-only --diff-filter=AMR $BASE_REF...$HEAD_REF"
          
          FILES_TO_PROCESS=$($GIT_DIFF_CMD)

          if [[ -z "$FILES_TO_PROCESS" ]]; then
            echo "No meaningful (non-whitespace) file changes were detected. Workflow will stop."
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_files=true" >> $GITHUB_OUTPUT
          echo "Files to process:"
          echo "$FILES_TO_PROCESS"
          
          mkdir -p .diff_cache

          # 同样在生成 diff 内容时忽略空格，以提供更干净的 diff 给 LLM
          MODIFIED_FILES=$(git diff -w --name-only --diff-filter=MR $BASE_REF...$HEAD_REF)
          for file in $MODIFIED_FILES; do
            diff_filename=$(echo "$file" | tr '/' '_')
            git diff -w --no-prefix $BASE_REF...$HEAD_REF -- "$file" > ".diff_cache/${diff_filename}.diff"
            echo "  - Created whitespace-ignored diff for $file"
          done

          FILES_TO_PROCESS_ARG=$(echo "$FILES_TO_PROCESS" | tr '\n' ',' | sed 's/,$//')
          echo "files=${FILES_TO_PROCESS_ARG}" >> $GITHUB_OUTPUT

      - name: 🚀 Run Translation Bootstrap Script
        if: steps.files-to-process.outputs.has_files == 'true'
        run: |
          python crater-website/hack/i18n/bootstrap.py --changed-files "${{ steps.files-to-process.outputs.files }}"

      - name: 🤖 Create Pull Request with Translations
        if: steps.files-to-process.outputs.has_files == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: "chore(i18n): 自动同步多语言翻译"
          title: "🌐 [Auto-Translate] 同步多语言文件"
          body: |
            由 **${{ secrets.APP_NAME }}** 机器人根据最新变更自动同步翻译。
            
            **触发事件:** `${{ github.event_name }}`
            
            *此 PR 只包含本次事件中独有的、有意义的变更（已忽略纯空格修改）。*
          branch: "feature/auto-translate-${{ github.run_id }}"
          delete-branch: true
          labels: "i18n, automated"
          author: ${{ secrets.APP_NAME }}[bot] <${{ secrets.APP_ID }}+${{ secrets.APP_NAME }}[bot]@users.noreply.github.com>
          committer: ${{ secrets.APP_NAME }}[bot] <${{ secrets.APP_ID }}+${{ secrets.APP_NAME }}[bot]@users.noreply.github.com>