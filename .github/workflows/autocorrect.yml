# Copyright 2025 Crater
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: AutoCorrect Website Files  

on:
  pull_request:
    paths:
      - '.github/**'
      - 'crater-website/src/**'        
      - 'crater-website/content/**'

jobs:
  autocorrect:
    name: Run AutoCorrect on Website
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 获取新增和修改的文件列表
      # - name: Get changed files
      #   id: changed-files
      #   uses: tj-actions/changed-files@v44
      #   with:
      #     # 这是解决问题的关键：强制输出使用换行符作为分隔符
      #     separator: '\n'

      # # 3. 动态生成 .autocorrectignore 文件 (安全版)
      # # 3. 动态生成 .autocorrectignore 文件 (最终版)
      # - name: Generate .autocorrectignore for this PR
      #   if: steps.changed-files.outputs.added_files != '' || steps.changed-files.outputs.modified_files != ''
      #   run: |
      #     echo "Generating .autocorrectignore from added and modified files..."
          
      #     # 步骤A: 使用 printf "%b" 来正确处理 \n 转义字符，并写入临时文件
      #     {
      #       printf "%b\n" "${{ steps.changed-files.outputs.added_files }}"
      #       printf "%b\n" "${{ steps.changed-files.outputs.modified_files }}"
      #     } > files_to_check.txt
          
      #     # 步骤B: 基于临时文件生成 .autocorrectignore
      #     echo '*' > .autocorrectignore
          
      #     # 从现在格式正确的文件中逐行读取
      #     while IFS= read -r file; do
      #       # 确保不处理空行
      #       if [ -n "$file" ]; then
      #         echo "!$file" >> .autocorrectignore
      #       fi
      #     done < files_to_check.txt
          
      #     echo "--- Generated .autocorrectignore content ---"
      #     cat .autocorrectignore
      #     echo "--------------------------------------------"

      # 4. 运行 AutoCorrect
      # Action 会自动读取我们刚刚生成的 .autocorrectignore 文件
      - name: AutoCorrect
        # if: steps.changed-files.outputs.all_changed_files != ''
        uses: huacnlee/autocorrect-action@v2

      # 5. 运行 ReviewDog 报告
      # 同样，它也会遵循 .autocorrectignore 的规则
      - name: Report ReviewDog
        if: failure() && steps.changed-files.outputs.all_changed_files != ''
        uses: huacnlee/autocorrect-action@v2
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          reviewdog: true